
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Practical Three: Spatial modelling in R &#8212; GIS and Spatial Methods in R</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet" />
  <link href="../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Landscape Ecology and Conservation" href="../practical_4/LEC_week.html" />
    <link rel="prev" title="Practical Two: Species Distribution Modelling" href="../practical_2/practical_2.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">GIS and Spatial Methods in R</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../intro.html">
   Introduction to the practicals
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../required_packages.html">
   Practical setup for local computers
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../practical_1/practical_1.html">
   GIS Practical 1
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../practical_2/practical_2.html">
   GIS Practical 2
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   GIS Practical 3
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../practical_4/LEC_week.html">
   Landscape Ecology
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        <a class="dropdown-buttons"
            href="../_sources/practical_3/practical_3.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download notebook file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/practical_3/practical_3.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/executablebooks/jupyter-book/master?urlpath=tree/practical_3/practical_3.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#required-packages">
   Required packages
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#the-dataset">
   The dataset
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#loading-the-data">
     Loading the data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#formatting-the-data-as-a-data-frame">
     Formatting the data as a data frame
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#more-data-exploration">
     More data exploration
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#correlations-and-spatial-data">
   Correlations and spatial data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#neighbourhoods">
   Neighbourhoods
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#dnearneigh">
     dnearneigh
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#knearneigh">
     knearneigh
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#spatial-weights">
     Spatial weights
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#more-data-cleaning">
       More data cleaning
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#calculating-weights">
       Calculating weights
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#spatial-autocorrelation-metrics">
   Spatial autocorrelation metrics
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#global-spatial-autocorrelation">
     Global spatial autocorrelation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#local-spatial-autocorrelation">
     Local spatial autocorrelation
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#autoregressive-models">
   Autoregressive models
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#correlograms">
     Correlograms
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#generalised-least-squares">
   Generalised least squares
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#eigenvector-filtering">
   Eigenvector filtering
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="practical-three-spatial-modelling-in-r">
<h1>Practical Three: Spatial modelling in R<a class="headerlink" href="#practical-three-spatial-modelling-in-r" title="Permalink to this headline">¶</a></h1>
<p>This practical looks at some of the problems of fitting statistical models to spatial
data, using the statistical software R. We are going to be covering a lot of ground but:</p>
<blockquote>
<div><p>Do <strong>not</strong> panic.</p>
</div></blockquote>
<p>The intention in this practical is to show some options that are available for spatial
models in R. The main thing is to think about what the options are available, not in
learning how to do it all in one afternoon!</p>
<p>There are a lot of other resources out there to provide more detail and I <em>highly</em>
recommend this:</p>
<p><a class="reference external" href="https://rspatial.org/raster/analysis/index.html">https://rspatial.org/raster/analysis/index.html</a></p>
<div class="section" id="required-packages">
<h2>Required packages<a class="headerlink" href="#required-packages" title="Permalink to this headline">¶</a></h2>
<p>As with species distribution mdelling, there are many packages used in spatial
modelling. There is an intimidating complete list of topics and packages here:</p>
<p><a class="reference external" href="https://CRAN.R-project.org/view=Spatial">https://CRAN.R-project.org/view=Spatial</a></p>
<p>We will need to load the following packages. Remember to read <a class="reference internal" href="../required_packages.html"><span class="doc std std-doc">this guide on setting up
packages on your computer</span></a> if you are running these practicals
on your own machine, not RStudio Cloud.</p>
<div class="cell tag_remove-stderr docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="n">ncf</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">raster</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">sf</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">spdep</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">SpatialPack</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">spatialreg</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">nlme</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">spgwr</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">spmoran</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
</div>
<div class="section" id="the-dataset">
<h2>The dataset<a class="headerlink" href="#the-dataset" title="Permalink to this headline">¶</a></h2>
<p>We will use some data taken from a paper that looked at trying to predict what limits
species ranges:</p>
<blockquote>
<div><p>McInnes, L., Purvis, A., &amp; Orme, C. D. L. (2009). Where do species’ geographic ranges
stop and why? Landscape impermeability and the Afrotropical avifauna. Proceedings of
the Royal Society Series B - Biological Sciences, 276(1670), 3063-3070.
<a class="reference external" href="http://doi.org/10.1098/rspb.2009.0656">http://doi.org/10.1098/rspb.2009.0656</a></p>
</div></blockquote>
<p>We won’t actually be looking at range edges but we’re going to use four variables taken
from the data used in this paper. The data is all saved as GeoTIFF files, so we’re
starting with raster data. The files cover the Afrotropics and are all projected in the
Behrmann equal area projection. This is a cylindrical equal area projection with a
<em>latitude of true scale</em> of 30°. What that <em>means</em> is that distances on the projected
map correspond to distances over the surface of the Earth at ±30° of latitude.</p>
<p>That is the reason for the odd resolution of this data: 96.48627 km. The circumference
of the Earth at ±30° - the length of the parallels at ±30° - is ~ 34735.06 km and this
resolution splits the map into 360 cells giving a resolution comparable to a degree
longitude at 30° N. Unlike a one degree resolution grid, however, these grid cells all
cover an <strong>equal area</strong> on the ground (<span class="math notranslate nohighlight">\(96.48627 \times 96.48627 = 9309.6 \text{km}^2\)</span>,
roughly the land area of Cyprus).</p>
<p>The variables for each grid cell are:</p>
<ul class="simple">
<li><p>the avian species richness across the Afrotropics,</p></li>
<li><p>the mean elevation,</p></li>
<li><p>the average annual temperature, and</p></li>
<li><p>the average annual actual evapotranspiration.</p></li>
</ul>
<div class="section" id="loading-the-data">
<h3>Loading the data<a class="headerlink" href="#loading-the-data" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># load the four variables from their TIFF files</span>
<span class="n">rich</span> <span class="o">&lt;-</span> <span class="nf">raster</span><span class="p">(</span><span class="s">&#39;data/spatial_models/avian_richness.tif&#39;</span><span class="p">)</span>
<span class="n">aet</span> <span class="o">&lt;-</span> <span class="nf">raster</span><span class="p">(</span><span class="s">&#39;data/spatial_models/mean_aet.tif&#39;</span><span class="p">)</span>
<span class="n">temp</span> <span class="o">&lt;-</span> <span class="nf">raster</span><span class="p">(</span><span class="s">&#39;data/spatial_models/mean_temp.tif&#39;</span><span class="p">)</span>
<span class="n">elev</span> <span class="o">&lt;-</span> <span class="nf">raster</span><span class="p">(</span><span class="s">&#39;data/spatial_models/elev.tif&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>It is always a good idea to look at the details of the data. One key skill in being a
good scientist and statistician is in looking at data and models and saying:</p>
<blockquote>
<div><p>Uh, that doesn’t make any sense, something has gone wrong.</p>
</div></blockquote>
<p>So we will quickly use some techniques to explore the data we have just loaded.</p>
<ol class="simple">
<li><p>We will look at the summary of the richness data. That shows us the dimensions of the
data, resolution, extent and coordinate reference system and the range of the data:
between 10 and 667 species per cell.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Look at the details of the richness data</span>
<span class="nf">print</span><span class="p">(</span><span class="n">rich</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>class      : RasterLayer 
dimensions : 75, 78, 5850  (nrow, ncol, ncell)
resolution : 96.48627, 96.48627  (x, y)
extent     : -1736.753, 5789.176, -4245.396, 2991.074  (xmin, xmax, ymin, ymax)
crs        : +proj=cea +lat_ts=30 +lon_0=0 +x_0=0 +y_0=0 +datum=WGS84 +units=km +no_defs 
source     : avian_richness.tif 
names      : avian_richness 
values     : 10, 667  (min, max)
</pre></div>
</div>
</div>
</div>
<p>We can also plot maps the variables and think about the spatial patterns in each.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">par</span><span class="p">(</span><span class="n">mfrow</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">2</span><span class="p">))</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">rich</span><span class="p">,</span> <span class="n">main</span><span class="o">=</span><span class="s">&#39;Avian species richness&#39;</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">aet</span><span class="p">,</span> <span class="n">main</span><span class="o">=</span><span class="s">&#39;Mean AET&#39;</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">main</span><span class="o">=</span><span class="s">&#39;Mean annual temperature&#39;</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">elev</span><span class="p">,</span> <span class="n">main</span><span class="o">=</span><span class="s">&#39;Elevation&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_3_8_0.png" src="../_images/practical_3_8_0.png" />
</div>
</div>
<p>We can use R to explore this data a bit further. We can use the <code class="docutils literal notranslate"><span class="pre">hist()</span></code> function to
plot the distribution of the values in each variable, not just look at the minimum and
maximum.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># split the figure area into a two by two layout</span>
<span class="nf">par</span><span class="p">(</span><span class="n">mfrow</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">2</span><span class="p">))</span>
<span class="c1"># plot a histogram of the values in each raster, setting nice &#39;main&#39; titles</span>
<span class="nf">hist</span><span class="p">(</span><span class="n">rich</span><span class="p">,</span> <span class="n">main</span><span class="o">=</span><span class="s">&#39;Avian species richness&#39;</span><span class="p">)</span>
<span class="nf">hist</span><span class="p">(</span><span class="n">aet</span><span class="p">,</span> <span class="n">main</span><span class="o">=</span><span class="s">&#39;Mean AET&#39;</span><span class="p">)</span>
<span class="nf">hist</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">main</span><span class="o">=</span><span class="s">&#39;Mean annual temperature&#39;</span><span class="p">)</span>
<span class="nf">hist</span><span class="p">(</span><span class="n">elev</span><span class="p">,</span> <span class="n">main</span><span class="o">=</span><span class="s">&#39;Elevation&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_3_11_0.png" src="../_images/practical_3_11_0.png" />
</div>
</div>
</div>
<div class="section" id="formatting-the-data-as-a-data-frame">
<h3>Formatting the data as a data frame<a class="headerlink" href="#formatting-the-data-as-a-data-frame" title="Permalink to this headline">¶</a></h3>
<p>We now have the data as rasters but some of the methods require the values in a data
frame. We’ll need to use two commands:</p>
<p>First, <code class="docutils literal notranslate"><span class="pre">stack()</span></code> allows us to concatenate the four rasters into a single object. Note
that this only works because all of these rasters have the same projection, extent and
resolution. In your own use, you would need to use GIS to set up your data so it can be
stacked like this.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Stack the data</span>
<span class="n">data_stack</span> <span class="o">&lt;-</span> <span class="nf">stack</span><span class="p">(</span><span class="n">rich</span><span class="p">,</span> <span class="n">aet</span><span class="p">,</span> <span class="n">elev</span><span class="p">,</span> <span class="n">temp</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">data_stack</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>class      : RasterStack 
dimensions : 75, 78, 5850, 4  (nrow, ncol, ncell, nlayers)
resolution : 96.48627, 96.48627  (x, y)
extent     : -1736.753, 5789.176, -4245.396, 2991.074  (xmin, xmax, ymin, ymax)
crs        : +proj=cea +lat_ts=30 +lon_0=0 +x_0=0 +y_0=0 +datum=WGS84 +units=km +no_defs 
names      : avian_richness,  mean_aet,      elev, mean_temp 
min values :        10.0000,   32.0600,    1.0000,   10.5246 
max values :       667.0000, 1552.6500, 2750.2800,   30.3667 
</pre></div>
</div>
</div>
</div>
<p>Second, <code class="docutils literal notranslate"><span class="pre">as()</span></code> allows us to convert an R object from one format to another. Here we
convert to the <code class="docutils literal notranslate"><span class="pre">SpatialPixelDataFrame</span></code> format from the <code class="docutils literal notranslate"><span class="pre">sp</span></code> package. This is a useful
format because it works very like a data frame, but identifies the geometry as pixels.
Note that the names of the <em>variables in the data frame have been set from the original
TIFF filenames</em>, not our variable names in R.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">data_spdf</span> <span class="o">&lt;-</span> <span class="nf">as</span><span class="p">(</span><span class="n">data_stack</span><span class="p">,</span> <span class="s">&#39;SpatialPixelsDataFrame&#39;</span><span class="p">)</span>
<span class="nf">summary</span><span class="p">(</span><span class="n">data_spdf</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Object of class SpatialPixelsDataFrame
Coordinates:
        min      max
x -1736.753 5789.176
y -4245.396 2991.074
Is projected: TRUE 
proj4string :
[+proj=cea +lat_ts=30 +lon_0=0 +x_0=0 +y_0=0 +datum=WGS84 +units=km
+no_defs]
Number of points: 2484
Grid attributes:
   cellcentre.offset cellsize cells.dim
s1         -1688.510 96.48627        78
s2         -4197.153 96.48627        75
Data attributes:
 avian_richness     mean_aet            elev          mean_temp    
 Min.   : 10.0   Min.   :  32.06   Min.   :   1.0   Min.   :10.52  
 1st Qu.:202.0   1st Qu.: 439.70   1st Qu.: 317.7   1st Qu.:21.83  
 Median :269.5   Median : 754.59   Median : 548.8   Median :24.71  
 Mean   :268.4   Mean   : 732.07   Mean   : 672.0   Mean   :24.25  
 3rd Qu.:341.0   3rd Qu.: 996.60   3rd Qu.:1023.2   3rd Qu.:27.15  
 Max.   :667.0   Max.   :1552.65   Max.   :2750.3   Max.   :30.37  
</pre></div>
</div>
</div>
</div>
<p>We can also that into a <code class="docutils literal notranslate"><span class="pre">sf</span></code> object, which we have been using in previous practicals.
These differ in how they represent the geometry:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">SpatialPixelDataFrame</span></code>: this holds the data as values in <em>pixels</em>, so ‘knows’ that
the values represents an area.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sf</span></code>: the default conversion here holds the data as values at a point.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">data_sf</span> <span class="o">&lt;-</span> <span class="nf">st_as_sf</span><span class="p">(</span><span class="n">data_spdf</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">data_sf</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Simple feature collection with 2484 features and 4 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: -1736.753 ymin: -4245.396 xmax: 5789.176 ymax: 2991.074
Projected CRS: unnamed
First 10 features:
   avian_richness mean_aet     elev mean_temp                  geometry
1              55 157.4988  619.990   25.5596 POINT (5451.474 2942.831)
2              52 117.5050  353.648   26.7782  POINT (5547.96 2942.831)
3              44  93.1765  270.054   27.3340 POINT (5644.447 2942.831)
4              45  86.4079 1043.670   24.9595 POINT (3907.694 2846.345)
5              38 136.8711  353.393   27.2728 POINT (5451.474 2846.345)
6              50  99.2078  773.086   24.9603  POINT (5547.96 2846.345)
7              49 110.1031  610.546   25.6667 POINT (5644.447 2846.345)
8              38 122.4231  820.173   25.0142 POINT (5740.933 2846.345)
9              58  70.4857  294.331   28.0947 POINT (3811.208 2749.859)
10             59 115.8227 1064.230   24.9419 POINT (3907.694 2749.859)
</pre></div>
</div>
</div>
</div>
<div class="admonition-affine-transformation-sidebar admonition">
<p class="admonition-title">Affine transformation sidebar</p>
<p>Just to show off <code class="docutils literal notranslate"><span class="pre">sf</span></code> a bit - and do something a bit more complex with <code class="docutils literal notranslate"><span class="pre">sf</span></code>
objects - we can turn that point data into polygon data. Each cell is the centre
of a cell with sides of ~96 km: we can use those points to define <a class="reference external" href="https://r-spatial.github.io/sf/articles/sf3.html">affine
transformations</a>. This means
we can create a template polygon that is the right size for the grid cells,
centred on zero and then use the points to move them all into the right place.</p>
<p>This code is a little bit trickier! Also, if I’m being honest, a polygon grid
isn’t a great way to store raster data!</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get the cell resolution</span>
<span class="n">cellsize</span> <span class="o">&lt;-</span> <span class="nf">res</span><span class="p">(</span><span class="n">rich</span><span class="p">)[[</span><span class="m">1</span><span class="p">]]</span>
<span class="c1"># Make the template polygon</span>
<span class="n">template</span> <span class="o">&lt;-</span> <span class="nf">st_polygon</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="nf">matrix</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">-1</span><span class="p">,</span><span class="m">-1</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">-1</span><span class="p">,</span><span class="m">-1</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">-1</span><span class="p">,</span><span class="m">-1</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="m">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">cellsize</span> <span class="o">/</span> <span class="m">2</span><span class="p">))</span>
<span class="c1"># Add each of the data points to the template</span>
<span class="n">polygon_data</span> <span class="o">&lt;-</span> <span class="nf">lapply</span><span class="p">(</span><span class="n">data_sf</span><span class="o">$</span><span class="n">geometry</span><span class="p">,</span> <span class="nf">function</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span> <span class="n">template</span> <span class="o">+</span> <span class="n">pt</span><span class="p">)</span>
<span class="n">data_poly</span> <span class="o">&lt;-</span> <span class="nf">st_sf</span><span class="p">(</span><span class="n">avian_richness</span> <span class="o">=</span> <span class="n">data_sf</span><span class="o">$</span><span class="n">avian_richness</span><span class="p">,</span> 
                   <span class="n">geometry</span><span class="o">=</span><span class="n">polygon_data</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">data_poly</span><span class="p">[</span><span class="s">&#39;avian_richness&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_3_19_0.png" src="../_images/practical_3_19_0.png" />
</div>
</div>
</div>
<div class="section" id="more-data-exploration">
<h3>More data exploration<a class="headerlink" href="#more-data-exploration" title="Permalink to this headline">¶</a></h3>
<p>We now have new data structures that have spatial information and matches up the
different variables across locations.</p>
<p>We can still plot the data as a map and the images below show the difference between the
<code class="docutils literal notranslate"><span class="pre">SpatialPixelsDataFrame</span></code> and the <code class="docutils literal notranslate"><span class="pre">sf</span></code> version of the data. The code has lots of odd
options: this combination of settings avoids each plot command insisting on the layout
it wants to use and lets us
<a class="reference external" href="https://www.r-spatial.org/r/2016/03/08/plotting-spatial-grids.html">control the layout of the plots</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the richness data as point data</span>
<span class="nf">layout</span><span class="p">(</span><span class="nf">matrix</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">3</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="m">3</span><span class="p">),</span> <span class="n">widths</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">5</span><span class="p">,</span><span class="m">5</span><span class="p">,</span><span class="m">1</span><span class="p">))</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">data_spdf</span><span class="p">[</span><span class="s">&#39;avian_richness&#39;</span><span class="p">],</span> <span class="n">col</span><span class="o">=</span><span class="nf">hcl.colors</span><span class="p">(</span><span class="m">20</span><span class="p">),</span> <span class="n">what</span><span class="o">=</span><span class="s">&#39;image&#39;</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">data_sf</span><span class="p">[</span><span class="s">&#39;avian_richness&#39;</span><span class="p">],</span> <span class="n">key.pos</span><span class="o">=</span><span class="kc">NULL</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">,</span> <span class="n">main</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> 
     <span class="n">pal</span><span class="o">=</span><span class="n">hcl.colors</span><span class="p">,</span> <span class="n">cex</span><span class="o">=</span><span class="m">0.7</span><span class="p">,</span> <span class="n">pch</span><span class="o">=</span><span class="m">20</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">data_spdf</span><span class="p">[</span><span class="s">&#39;avian_richness&#39;</span><span class="p">],</span> <span class="n">col</span><span class="o">=</span><span class="nf">hcl.colors</span><span class="p">(</span><span class="m">20</span><span class="p">),</span> <span class="n">what</span><span class="o">=</span><span class="s">&#39;scale&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_3_21_0.png" src="../_images/practical_3_21_0.png" />
</div>
</div>
<p>We can also plot the variables against each other, by treating the new object as a data
frame:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create three figures in a single panel</span>
<span class="nf">par</span><span class="p">(</span><span class="n">mfrow</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">3</span><span class="p">))</span>
<span class="c1"># Now plot richness as a function of each environmental variable</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">avian_richness</span> <span class="o">~</span> <span class="n">mean_aet</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data_sf</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">avian_richness</span> <span class="o">~</span> <span class="n">mean_temp</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data_sf</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">avian_richness</span> <span class="o">~</span> <span class="n">elev</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data_sf</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_3_24_0.png" src="../_images/practical_3_24_0.png" />
</div>
</div>
</div>
</div>
<div class="section" id="correlations-and-spatial-data">
<h2>Correlations and spatial data<a class="headerlink" href="#correlations-and-spatial-data" title="Permalink to this headline">¶</a></h2>
<p>A <strong>correlation coefficient</strong> is a standardised measure between -1 and 1 showing how
much observations of two variables tend to co-vary. For a positive correlation, both
variables tend to have high values in the same locations and low values in the same
locations. Negative correlations show the opposite. Once you’ve calculated a
correlation, you need to assess how strong that correlation is <em>given the amount of data
you have</em>: it is easy to get large <span class="math notranslate nohighlight">\(r\)</span> values in small datasets by chance.</p>
<p>However, correlation coefficients assume that the data points are independent and this
is not true for spatial data. Nearby data points tend to be similar: if you are in a
warm location, surrounding areas will also tend to be warm. One relatively simple way of
removing this non-independence is to calculate the significance of tests as if you had
fewer data points.</p>
<p>We will use this approach to compare standard measures of correlation to spatially
corrected ones. We need to load a new set of functions that implement a modification to
the correlation test that accounts for spatial similarity, described in
<a class="reference external" href="https://jstor.org/stable/2532039">this paper</a>. The modified test does not change the
correlation statistic itself but calculates a new effective sample size and uses this in
calculating the <span class="math notranslate nohighlight">\(F\)</span> statistic.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use the modified.ttest function from SpatialPack</span>
<span class="n">temp_corr</span> <span class="o">&lt;-</span> <span class="nf">modified.ttest</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">data_sf</span><span class="o">$</span><span class="n">avian_richness</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">data_sf</span><span class="o">$</span><span class="n">mean_temp</span><span class="p">,</span> 
                            <span class="n">coords</span><span class="o">=</span><span class="nf">st_coordinates</span><span class="p">(</span><span class="n">data_sf</span><span class="p">))</span>
<span class="nf">print</span><span class="p">(</span><span class="n">temp_corr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Corrected Pearson&#39;s correlation for spatial autocorrelation

data: x and y ; coordinates: X and Y 
F-statistic: 5.1886 on 1 and 32.263 DF, p-value: 0.0295 
alternative hypothesis: true autocorrelation is not equal to 0
sample correlation: -0.3722
</pre></div>
</div>
</div>
</div>
<div class="admonition-other-variables admonition">
<p class="admonition-title">Other variables</p>
<p>Use this code to look at how the other explanatory variables  with bird richness.
It is also worth looking at correlations between the explanatory variables!</p>
</div>
</div>
<div class="section" id="neighbourhoods">
<h2>Neighbourhoods<a class="headerlink" href="#neighbourhoods" title="Permalink to this headline">¶</a></h2>
<p>One of the core concepts in many spatial statistical methods is the <strong>neighbourhood</strong> of
cells. The neighbourhood of a cell defines a set of other cells that are connected to
the focal cell, often with a given weight. The neighbourhood is one way of providing
spatial structure to the statistical methods and there are many options for doing this.
The <code class="docutils literal notranslate"><span class="pre">spdep</span></code> package provides a good guide (<code class="docutils literal notranslate"><span class="pre">vignette('nb')</span></code>) on the details, but we will
look at two functions: <code class="docutils literal notranslate"><span class="pre">dnearneigh</span></code> and <code class="docutils literal notranslate"><span class="pre">knearneigh</span></code>.</p>
<div class="section" id="dnearneigh">
<h3>dnearneigh<a class="headerlink" href="#dnearneigh" title="Permalink to this headline">¶</a></h3>
<p>We can use this function to find which cells are within a given distance of a focal
point. We can also put a minimum distance to exclude nearby, but we will keep that at
zero here. Working with raster data,where points are on an even grid, we can use this
function to generate the <strong>Rook</strong> and <strong>Queen</strong> move neighbours. To do that we need to
get the resolution of the raster and use that to set appropriate distances.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Give dnearneigh the coordinates of the points and the distances to use</span>
<span class="n">rook</span> <span class="o">&lt;-</span> <span class="nf">dnearneigh</span><span class="p">(</span><span class="n">data_sf</span><span class="p">,</span> <span class="n">d1</span><span class="o">=</span><span class="m">0</span><span class="p">,</span> <span class="n">d2</span><span class="o">=</span><span class="n">cellsize</span><span class="p">)</span>
<span class="n">queen</span> <span class="o">&lt;-</span> <span class="nf">dnearneigh</span><span class="p">(</span><span class="n">data_sf</span><span class="p">,</span> <span class="n">d1</span><span class="o">=</span><span class="m">0</span><span class="p">,</span> <span class="n">d2</span><span class="o">=</span><span class="nf">sqrt</span><span class="p">(</span><span class="m">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">cellsize</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>If we look at those in a bit more details we can see that they are very similar but -
surprise! - there are more cells linked as neighbours in <code class="docutils literal notranslate"><span class="pre">queen</span></code>. Using <code class="docutils literal notranslate"><span class="pre">head</span></code> allows us
to see the row numbers in our data frame that are neighbours. We can also look at the
number of neighbours in each set (the <em>cardinality</em>, hence the function name <code class="docutils literal notranslate"><span class="pre">card</span></code>). If
we store that in our <code class="docutils literal notranslate"><span class="pre">data_sf</span></code> data frame, we can then visualise the number of
neighbours.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">print</span><span class="p">(</span><span class="n">rook</span><span class="p">)</span>
<span class="nf">head</span><span class="p">(</span><span class="n">rook</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="m">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Neighbour list object:
Number of regions: 2484 
Number of nonzero links: 6010 
Percentage nonzero weights: 0.09740277 
Average number of links: 2.419485 
4 regions with no links:
159 1311 1817 2204
</pre></div>
</div>
<div class="output text_html"><ol>
	<li><style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>2</li><li>5</li></ol>
</li>
	<li><style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>1</li><li>6</li></ol>
</li>
	<li>7</li>
</ol>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">print</span><span class="p">(</span><span class="n">queen</span><span class="p">)</span>
<span class="nf">head</span><span class="p">(</span><span class="n">queen</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="m">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Neighbour list object:
Number of regions: 2484 
Number of nonzero links: 18728 
Percentage nonzero weights: 0.3035206 
Average number of links: 7.539452 
3 regions with no links:
1311 1817 2204
</pre></div>
</div>
<div class="output text_html"><ol>
	<li><style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>2</li><li>5</li><li>6</li></ol>
</li>
	<li><style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>1</li><li>3</li><li>5</li><li>6</li><li>7</li></ol>
</li>
	<li><style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class=list-inline><li>2</li><li>6</li><li>7</li><li>8</li></ol>
</li>
</ol>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Store the neighbourhood cardinalities in data_sf</span>
<span class="n">data_sf</span><span class="o">$</span><span class="n">card_rook</span> <span class="o">&lt;-</span> <span class="nf">card</span><span class="p">(</span><span class="n">rook</span><span class="p">)</span>
<span class="n">data_sf</span><span class="o">$</span><span class="n">card_queen</span> <span class="o">&lt;-</span> <span class="nf">card</span><span class="p">(</span><span class="n">queen</span><span class="p">)</span>
<span class="c1"># Look at the count of rook and queen neighbours for each point</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">data_sf</span><span class="p">[</span><span class="nf">c</span><span class="p">(</span><span class="s">&#39;card_rook&#39;</span><span class="p">,</span> <span class="s">&#39;card_queen&#39;</span><span class="p">)],</span> <span class="n">key.pos</span><span class="o">=</span><span class="m">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_3_33_0.png" src="../_images/practical_3_33_0.png" />
</div>
</div>
<p>That <strong>does not look correct</strong> - we should not be seeing those stripes in central Africa
with only two or three rook neighbours. The reason for this is using <em>exactly</em> the
resolution as our distance: minor rounding differences can lead to distance based
measures going wrong, so it is once again <strong>always a good idea to plot your data and
check</strong>!</p>
<div class="admonition-fix-the-neighbours admonition">
<p class="admonition-title">Fix the neighbours</p>
<p>A simple solution here is just to make the distance very slightly larger. Do this and
recreate the <code class="docutils literal notranslate"><span class="pre">rook</span></code> and <code class="docutils literal notranslate"><span class="pre">queen</span></code> neighbours. The new version should look like the figure
below.</p>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Recreate the neighbour adding 1km to the distance</span>
<span class="n">rook</span> <span class="o">&lt;-</span> <span class="nf">dnearneigh</span><span class="p">(</span><span class="n">data_sf</span><span class="p">,</span> <span class="n">d1</span><span class="o">=</span><span class="m">0</span><span class="p">,</span> <span class="n">d2</span><span class="o">=</span><span class="n">cellsize</span> <span class="o">+</span> <span class="m">1</span><span class="p">)</span>
<span class="n">queen</span> <span class="o">&lt;-</span> <span class="nf">dnearneigh</span><span class="p">(</span><span class="n">data_sf</span><span class="p">,</span> <span class="n">d1</span><span class="o">=</span><span class="m">0</span><span class="p">,</span> <span class="n">d2</span><span class="o">=</span><span class="nf">sqrt</span><span class="p">(</span><span class="m">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">cellsize</span> <span class="o">+</span> <span class="m">1</span><span class="p">)</span>
<span class="n">data_sf</span><span class="o">$</span><span class="n">card_rook</span> <span class="o">&lt;-</span> <span class="nf">card</span><span class="p">(</span><span class="n">rook</span><span class="p">)</span>
<span class="n">data_sf</span><span class="o">$</span><span class="n">card_queen</span> <span class="o">&lt;-</span> <span class="nf">card</span><span class="p">(</span><span class="n">queen</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">data_sf</span><span class="p">[</span><span class="nf">c</span><span class="p">(</span><span class="s">&#39;card_rook&#39;</span><span class="p">,</span> <span class="s">&#39;card_queen&#39;</span><span class="p">)],</span> <span class="n">key.pos</span><span class="o">=</span><span class="m">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_3_35_0.png" src="../_images/practical_3_35_0.png" />
</div>
</div>
</div>
<div class="section" id="knearneigh">
<h3>knearneigh<a class="headerlink" href="#knearneigh" title="Permalink to this headline">¶</a></h3>
<p>One thing to note in the details of <code class="docutils literal notranslate"><span class="pre">rook</span></code> and <code class="docutils literal notranslate"><span class="pre">queen</span></code> are the bits that say:</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="m">3</span> <span class="n">regions</span> <span class="n">with</span> <span class="n">no</span> <span class="n">links</span><span class="o">:</span>
<span class="m">1311</span> <span class="m">1817</span> <span class="m">2204</span> 
</pre></div>
</div>
<p>These are points that have no other point within the provided distance. These are
islands: São Tomé and Principe, Comoros, and Réunion - it just happens that Mauritius
falls into two cells and so has itself as a neighbour. The <code class="docutils literal notranslate"><span class="pre">knearneigh</span></code> function ensures
that all points have the same number of neighbours by looking for the <span class="math notranslate nohighlight">\(k\)</span> closest
locations. You end up with a matrix</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">knn</span> <span class="o">&lt;-</span> <span class="nf">knearneigh</span><span class="p">(</span><span class="n">data_sf</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="m">8</span><span class="p">)</span>
<span class="c1"># We have to look at the `nn` values in `knn` to see the matrix of neighbours</span>
<span class="nf">head</span><span class="p">(</span><span class="n">knn</span><span class="o">$</span><span class="n">nn</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="m">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="dataframe">
<caption>A matrix: 3 × 8 of type int</caption>
<tbody>
	<tr><td>5</td><td>2</td><td>6</td><td>3</td><td>11</td><td> 7</td><td>12</td><td> 8</td></tr>
	<tr><td>6</td><td>1</td><td>3</td><td>5</td><td> 7</td><td>11</td><td>12</td><td> 8</td></tr>
	<tr><td>7</td><td>2</td><td>8</td><td>6</td><td>12</td><td> 1</td><td>13</td><td>11</td></tr>
</tbody>
</table>
</div></div>
</div>
</div>
<div class="section" id="spatial-weights">
<h3>Spatial weights<a class="headerlink" href="#spatial-weights" title="Permalink to this headline">¶</a></h3>
<p>The neighbourhood functions just give us sets of neighbours, and most spatial modelling
functions require <strong>weights</strong> to be assigned to neighbours. In <code class="docutils literal notranslate"><span class="pre">spdep</span></code>, we need to use
<code class="docutils literal notranslate"><span class="pre">nb2listw</span></code> to take our plain sets of neighbours and make them into weighted neighbour
lists.</p>
<div class="cell tag_raises-exception docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">queen</span> <span class="o">&lt;-</span> <span class="nf">nb2listw</span><span class="p">(</span><span class="n">queen</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="n">Error</span> <span class="ow">in</span> <span class="n">nb2listw</span><span class="p">(</span><span class="n">queen</span><span class="p">):</span> <span class="n">Empty</span> <span class="n">neighbour</span> <span class="n">sets</span> <span class="n">found</span>
<span class="ne">Traceback</span>:

<span class="mi">1</span><span class="o">.</span> <span class="n">nb2listw</span><span class="p">(</span><span class="n">queen</span><span class="p">)</span>
<span class="mi">2</span><span class="o">.</span> <span class="n">stop</span><span class="p">(</span><span class="s2">&quot;Empty neighbour sets found&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>That didn’t work! The error message is fairly clear (for R) - we <strong>cannot</strong> create
weighted lists for locations with no neighbours. We have two choices here:</p>
<ol class="simple">
<li><p>Remove the points with no neighbours - given these are isolated offshore islands,
this seems reasonable.</p></li>
<li><p>Use a neighbourhood system in which they are not isolated. We already have this using
<code class="docutils literal notranslate"><span class="pre">knearneigh</span></code>, but you do have to ask yourself if a model that arbitrarily links
offshore islands is realistic.</p></li>
</ol>
<div class="section" id="more-data-cleaning">
<h4>More data cleaning<a class="headerlink" href="#more-data-cleaning" title="Permalink to this headline">¶</a></h4>
<p>It would be easy to use <code class="docutils literal notranslate"><span class="pre">subset</span></code> on <code class="docutils literal notranslate"><span class="pre">data_sf</span></code> to remove cells with zero neighbours, but
we really should remove Mauritius as well (two cells with cardinality of 1).
Unfortunately there is a coastal cell with a rook cardinality of 1 in the north of
Madagascar, and that probably is reasonable to include! So, we will use a GIS operation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Polygon covering Mauritius</span>
<span class="n">mauritius</span> <span class="o">&lt;-</span> <span class="nf">st_polygon</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="nf">matrix</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">5000</span><span class="p">,</span> <span class="m">6000</span><span class="p">,</span> <span class="m">6000</span><span class="p">,</span> <span class="m">5000</span><span class="p">,</span> <span class="m">5000</span><span class="p">,</span>
                                    <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">-4000</span><span class="p">,</span> <span class="m">-4000</span><span class="p">,</span> <span class="m">0</span><span class="p">),</span> 
                                    <span class="n">ncol</span><span class="o">=</span><span class="m">2</span><span class="p">)))</span>
<span class="n">mauritius</span> <span class="o">&lt;-</span> <span class="nf">st_sfc</span><span class="p">(</span><span class="n">mauritius</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="nf">crs</span><span class="p">(</span><span class="n">data_sf</span><span class="p">))</span>
<span class="c1"># Remove the island cells with zero neighbours</span>
<span class="n">data_sf</span> <span class="o">&lt;-</span> <span class="nf">subset</span><span class="p">(</span><span class="n">data_sf</span><span class="p">,</span> <span class="n">card_rook</span> <span class="o">&gt;</span> <span class="m">0</span><span class="p">)</span>
<span class="c1"># Remove Mauritius</span>
<span class="n">data_sf</span> <span class="o">&lt;-</span> <span class="nf">st_difference</span><span class="p">(</span><span class="n">data_sf</span><span class="p">,</span> <span class="n">mauritius</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Warning message:
“attribute variables are assumed to be spatially constant throughout all geometries”
</pre></div>
</div>
</div>
</div>
<p>We do now need to recalculate our neighbourhood objects to use that reduced set of
locations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">rook</span> <span class="o">&lt;-</span> <span class="nf">dnearneigh</span><span class="p">(</span><span class="n">data_sf</span><span class="p">,</span> <span class="n">d1</span><span class="o">=</span><span class="m">0</span><span class="p">,</span> <span class="n">d2</span><span class="o">=</span><span class="n">cellsize</span> <span class="o">+</span> <span class="m">1</span><span class="p">)</span>
<span class="n">queen</span> <span class="o">&lt;-</span> <span class="nf">dnearneigh</span><span class="p">(</span><span class="n">data_sf</span><span class="p">,</span> <span class="n">d1</span><span class="o">=</span><span class="m">0</span><span class="p">,</span> <span class="n">d2</span><span class="o">=</span><span class="nf">sqrt</span><span class="p">(</span><span class="m">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">cellsize</span> <span class="o">+</span> <span class="m">1</span><span class="p">)</span>
<span class="n">data_sf</span><span class="o">$</span><span class="n">card_rook</span> <span class="o">&lt;-</span> <span class="nf">card</span><span class="p">(</span><span class="n">rook</span><span class="p">)</span>
<span class="n">data_sf</span><span class="o">$</span><span class="n">card_queen</span> <span class="o">&lt;-</span> <span class="nf">card</span><span class="p">(</span><span class="n">queen</span><span class="p">)</span>
<span class="n">knn</span> <span class="o">&lt;-</span> <span class="nf">knearneigh</span><span class="p">(</span><span class="n">data_sf</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="m">8</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="calculating-weights">
<h4>Calculating weights<a class="headerlink" href="#calculating-weights" title="Permalink to this headline">¶</a></h4>
<p>There are several weighting styles and choosing different strategies obviously affects
the resulting statistics. One option is <strong>binary</strong> weights (cells are either connected
or not) but there are other options. Here we will use the default <em>row standardised</em>
(<code class="docutils literal notranslate"><span class="pre">style='W'</span></code>), which just means that the neighbours of location all get the same weight
but the sum of neighbour weights for location is always one.</p>
<p>Note that <code class="docutils literal notranslate"><span class="pre">knn</span></code> needs to be converted to the same format (<code class="docutils literal notranslate"><span class="pre">nb</span></code>) as the rook and queen
neighbourhoods first.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">rook</span> <span class="o">&lt;-</span> <span class="nf">nb2listw</span><span class="p">(</span><span class="n">rook</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s">&#39;W&#39;</span><span class="p">)</span>
<span class="n">queen</span> <span class="o">&lt;-</span> <span class="nf">nb2listw</span><span class="p">(</span><span class="n">queen</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s">&#39;W&#39;</span><span class="p">)</span>
<span class="n">knn</span> <span class="o">&lt;-</span> <span class="nf">nb2listw</span><span class="p">(</span><span class="nf">knn2nb</span><span class="p">(</span><span class="n">knn</span><span class="p">),</span> <span class="n">style</span><span class="o">=</span><span class="s">&#39;W&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="spatial-autocorrelation-metrics">
<h2>Spatial autocorrelation metrics<a class="headerlink" href="#spatial-autocorrelation-metrics" title="Permalink to this headline">¶</a></h2>
<p>Spatial autocorrelation describes the extent to which points that are close together in
space show similar values. It can be measured globally and locally - note that
<strong>global</strong> here means <em>the whole of the dataset</em> and not the whole of the Earth.</p>
<div class="section" id="global-spatial-autocorrelation">
<h3>Global spatial autocorrelation<a class="headerlink" href="#global-spatial-autocorrelation" title="Permalink to this headline">¶</a></h3>
<p>There are a number of statistics that quantify the level of global spatial
autocorrelation in a dataset. These statistics test if the dataset as a whole shows
spatial autocorrelation.</p>
<p>We will be looking at the commonly used Moran’s <span class="math notranslate nohighlight">\(I\)</span> and Geary’s <span class="math notranslate nohighlight">\(C\)</span> statistics</p>
<ul class="simple">
<li><p>Moran’s <span class="math notranslate nohighlight">\(I\)</span> takes values between -1 and 1, with the central value of 0 showing that
there is no spatial autocorrelation. Values close to -1 show strong negative
autocorrelation, which is the unusual case that nearby cells have unexpectedly
<strong>different</strong> values and values close to 1 show that nearby cells have unexpectedly
<strong>similar</strong> values.</p></li>
<li><p>Geary’s <span class="math notranslate nohighlight">\(C\)</span> scales the other way around. It is not perfectly correlated with Moran’s
<span class="math notranslate nohighlight">\(I\)</span> but closely related.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">moran_avian_richness</span> <span class="o">&lt;-</span> <span class="nf">moran.test</span><span class="p">(</span><span class="n">data_sf</span><span class="o">$</span><span class="n">avian_richness</span><span class="p">,</span> <span class="n">rook</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">moran_avian_richness</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>	Moran I test under randomisation

data:  data_sf$avian_richness  
weights: rook    

Moran I statistic standard deviate = 64.66, p-value &lt; 2.2e-16
alternative hypothesis: greater
sample estimates:
Moran I statistic       Expectation          Variance 
     0.9499254829     -0.0004035513      0.0002160130 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">geary_avian_richness</span> <span class="o">&lt;-</span> <span class="nf">geary.test</span><span class="p">(</span><span class="n">data_sf</span><span class="o">$</span><span class="n">avian_richness</span><span class="p">,</span> <span class="n">rook</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">geary_avian_richness</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>	Geary C test under randomisation

data:  data_sf$avian_richness 
weights: rook 

Geary C statistic standard deviate = 64.254, p-value &lt; 2.2e-16
alternative hypothesis: Expectation greater than statistic
sample estimates:
Geary C statistic       Expectation          Variance 
     0.0468078533      1.0000000000      0.0002200701 
</pre></div>
</div>
</div>
</div>
<div class="admonition-variables-and-neighbours admonition">
<p class="admonition-title">Variables and neighbours</p>
<p>Look to see if the different neighbourhood schemes increase or decrease spatial
autocorrelation. Do all of the other three variables show significant spatial autocorrelation?</p>
</div>
</div>
<div class="section" id="local-spatial-autocorrelation">
<h3>Local spatial autocorrelation<a class="headerlink" href="#local-spatial-autocorrelation" title="Permalink to this headline">¶</a></h3>
<p>We can also look at local indicators of spatial autocorrelation (LISA) to show areas of
stronger or weaker similarity. These calculate a similar statistic but only within the
neighbourhood around each cell and report back the calculated value for each cell, which
we can then map.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">localmoran</span></code> function outputs a matrix of values. The columns contain observed <span class="math notranslate nohighlight">\(I\)</span>,
the expected value, variance, <span class="math notranslate nohighlight">\(z\)</span> statistics and <span class="math notranslate nohighlight">\(p\)</span> value and the rows contain the
location specific measures of each variable, so we can load them into <code class="docutils literal notranslate"><span class="pre">data_sf</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">local_moran_avr</span> <span class="o">&lt;-</span> <span class="nf">localmoran</span><span class="p">(</span><span class="n">data_sf</span><span class="o">$</span><span class="n">avian_richness</span><span class="p">,</span> <span class="n">rook</span><span class="p">)</span>
<span class="n">data_sf</span><span class="o">$</span><span class="n">local_moran_avr</span> <span class="o">&lt;-</span> <span class="n">local_moran_avr</span><span class="p">[,</span> <span class="s">&#39;Ii&#39;</span><span class="p">]</span> <span class="c1"># Observed Moran&#39;s I</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">data_sf</span><span class="p">[</span><span class="s">&#39;local_moran_avr&#39;</span><span class="p">],</span> <span class="n">cex</span><span class="o">=</span><span class="m">0.6</span><span class="p">,</span> <span class="n">pch</span><span class="o">=</span><span class="m">20</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_3_51_0.png" src="../_images/practical_3_51_0.png" />
</div>
</div>
<p>The similar function <code class="docutils literal notranslate"><span class="pre">localG</span></code> just calculates a <span class="math notranslate nohighlight">\(z\)</span> statistic showing strength of local
autocorrelation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">data_sf</span><span class="o">$</span><span class="n">local_g_avian_richness</span> <span class="o">&lt;-</span> <span class="nf">localG</span><span class="p">(</span><span class="n">data_sf</span><span class="o">$</span><span class="n">avian_richness</span><span class="p">,</span> <span class="n">rook</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">data_sf</span><span class="p">[</span><span class="s">&#39;local_g_avian_richness&#39;</span><span class="p">],</span> <span class="n">cex</span><span class="o">=</span><span class="m">0.6</span><span class="p">,</span> <span class="n">pch</span><span class="o">=</span><span class="m">20</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_3_53_0.png" src="../_images/practical_3_53_0.png" />
</div>
</div>
<div class="admonition-exploring-local-spatial-autocorrelation admonition">
<p class="admonition-title">Exploring local spatial autocorrelation</p>
<p>As we might predict, avian richness shows strong positive spatial
autocorrelation, which seems to be particularly strong in the mountains around
Lake Victoria. Try these measures out on the other variables and neighbourhoods.</p>
</div>
</div>
</div>
<div class="section" id="autoregressive-models">
<h2>Autoregressive models<a class="headerlink" href="#autoregressive-models" title="Permalink to this headline">¶</a></h2>
<p>Our definition of a set of neighbours allows us to fit a spatial autoregressive (SAR)
model. This is a statistical model that predicts the value of a response variable in a
cell using the predictor variables and values of the response variable in neighbouring
cells. This is why they are called autoregressive models: they fit the response variable
partly as a response to itself.</p>
<p>They come in many different possible forms. This is a great paper explaining some of the
different forms with some great appendices including example R code:</p>
<blockquote>
<div><p>Kissling, W.D. and Carl, G. (2008), Spatial autocorrelation and the selection of
simultaneous autoregressive models. Global Ecology and Biogeography, 17: 59-71.
<a class="reference external" href="https://doi.org/10.1111/j.1466-8238.2007.00334.x">doi:10.1111/j.1466-8238.2007.00334.x</a></p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fit a simple linear model</span>
<span class="n">simple_model</span> <span class="o">&lt;-</span> <span class="nf">lm</span><span class="p">(</span><span class="n">avian_richness</span> <span class="o">~</span> <span class="n">mean_aet</span> <span class="o">+</span> <span class="n">elev</span> <span class="o">+</span> <span class="n">mean_temp</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data_sf</span><span class="p">)</span>
<span class="nf">summary</span><span class="p">(</span><span class="n">simple_model</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Call:
lm(formula = avian_richness ~ mean_aet + elev + mean_temp, data = data_sf)

Residuals:
    Min      1Q  Median      3Q     Max 
-286.82  -53.00   -1.53   51.95  324.58 

Coefficients:
              Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 198.276692  21.062878   9.414  &lt; 2e-16 ***
mean_aet      0.178391   0.004665  38.238  &lt; 2e-16 ***
elev          0.073595   0.005422  13.573  &lt; 2e-16 ***
mean_temp    -4.508362   0.713118  -6.322 3.05e-10 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 81.24 on 2475 degrees of freedom
Multiple R-squared:  0.4665,	Adjusted R-squared:  0.4659 
F-statistic: 721.4 on 3 and 2475 DF,  p-value: &lt; 2.2e-16
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fit a spatial autoregressive model: this is much slower and can take minutes to calculate</span>
<span class="n">sar_model</span> <span class="o">&lt;-</span> <span class="nf">errorsarlm</span><span class="p">(</span><span class="n">avian_richness</span> <span class="o">~</span> <span class="n">mean_aet</span> <span class="o">+</span> <span class="n">elev</span> <span class="o">+</span> <span class="n">mean_temp</span><span class="p">,</span> 
                        <span class="n">data</span><span class="o">=</span><span class="n">data_sf</span><span class="p">,</span> <span class="n">listw</span><span class="o">=</span><span class="n">queen</span><span class="p">)</span>
<span class="nf">summary</span><span class="p">(</span><span class="n">sar_model</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Call:errorsarlm(formula = avian_richness ~ mean_aet + elev + mean_temp, 
    data = data_sf, listw = queen)

Residuals:
       Min         1Q     Median         3Q        Max 
-218.57762   -9.64130   -0.54812    9.09747  109.78562 

Type: error 
Coefficients: (asymptotic standard errors) 
              Estimate Std. Error z value  Pr(&gt;|z|)
(Intercept) 44.2663339 64.8564135  0.6825   0.49490
mean_aet     0.0581636  0.0070908  8.2027 2.220e-16
elev         0.0485815  0.0067335  7.2149 5.396e-13
mean_temp    3.0505866  1.2710584  2.4000   0.01639

Lambda: 0.99316, LR test value: 6447.6, p-value: &lt; 2.22e-16
Asymptotic standard error: 0.0017541
    z-value: 566.2, p-value: &lt; 2.22e-16
Wald statistic: 320580, p-value: &lt; 2.22e-16

Log likelihood: -11193.01 for error model
ML residual variance (sigma squared): 364.6, (sigma: 19.095)
Number of observations: 2479 
Number of parameters estimated: 6 
AIC: 22398, (AIC for lm: 28844)
</pre></div>
</div>
</div>
</div>
<p>We can then look at the <strong>predictions</strong> of those models. We can extract the predicted
values for each point and put them into our spatial data frame and then map them.</p>
<div class="cell tag_remove-stderr docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># extract the predictions from the model into the spatial data frame</span>
<span class="n">data_sf</span><span class="o">$</span><span class="n">simple_fit</span> <span class="o">&lt;-</span> <span class="nf">predict</span><span class="p">(</span><span class="n">simple_model</span><span class="p">)</span>
<span class="n">data_sf</span><span class="o">$</span><span class="n">sar_fit</span> <span class="o">&lt;-</span> <span class="nf">predict</span><span class="p">(</span><span class="n">sar_model</span><span class="p">)</span>

<span class="c1"># Compare those two predictions with the data</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">data_sf</span><span class="p">[</span><span class="nf">c</span><span class="p">(</span><span class="s">&#39;avian_richness&#39;</span><span class="p">,</span><span class="s">&#39;simple_fit&#39;</span><span class="p">,</span><span class="s">&#39;sar_fit&#39;</span><span class="p">)],</span> 
     <span class="n">pal</span><span class="o">=</span><span class="nf">function</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="nf">hcl.colors</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">pal</span><span class="o">=</span><span class="s">&#39;Blue-Red&#39;</span><span class="p">),</span> <span class="n">key.pos</span><span class="o">=</span><span class="m">4</span><span class="p">,</span> <span class="n">pch</span><span class="o">=</span><span class="m">19</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_3_59_1.png" src="../_images/practical_3_59_1.png" />
</div>
</div>
<p>We can also look at the <strong>residuals</strong> of those models - the differences between the
prediction and the actual values - to highlight where the models aren’t working well.
The residuals from the SAR are <em>far</em> better behaved.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># extract the residuals from the model into the spatial data frame</span>
<span class="n">data_sf</span><span class="o">$</span><span class="n">simple_resid</span> <span class="o">&lt;-</span> <span class="nf">residuals</span><span class="p">(</span><span class="n">simple_model</span><span class="p">)</span>
<span class="n">data_sf</span><span class="o">$</span><span class="n">sar_resid</span> <span class="o">&lt;-</span> <span class="nf">residuals</span><span class="p">(</span><span class="n">sar_model</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">data_sf</span><span class="p">[</span><span class="nf">c</span><span class="p">(</span><span class="s">&#39;simple_resid&#39;</span><span class="p">,</span> <span class="s">&#39;sar_resid&#39;</span><span class="p">)],</span> 
     <span class="n">pal</span><span class="o">=</span><span class="nf">function</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="nf">hcl.colors</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">pal</span><span class="o">=</span><span class="s">&#39;Blue-Red&#39;</span><span class="p">),</span> <span class="n">key.pos</span><span class="o">=</span><span class="m">4</span><span class="p">,</span> <span class="n">pch</span><span class="o">=</span><span class="m">19</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_3_61_0.png" src="../_images/practical_3_61_0.png" />
</div>
</div>
<div class="section" id="correlograms">
<h3>Correlograms<a class="headerlink" href="#correlograms" title="Permalink to this headline">¶</a></h3>
<p>Correlograms are another way of visualising spatial autocorrelation. They show how the
correlation within a variable changes as the distance between pairs of points being
compared increases. To show this, we need the coordinates of the spatial data and the
values of a variable at each point.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># add the X and Y coordinates to the data frame</span>
<span class="n">data_xy</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="nf">st_coordinates</span><span class="p">(</span><span class="n">data_sf</span><span class="p">))</span>
<span class="n">data_sf</span><span class="o">$</span><span class="n">x</span> <span class="o">&lt;-</span> <span class="n">data_xy</span><span class="o">$</span><span class="n">X</span>
<span class="n">data_sf</span><span class="o">$</span><span class="n">y</span> <span class="o">&lt;-</span> <span class="n">data_xy</span><span class="o">$</span><span class="n">Y</span>

<span class="c1"># calculate a correlogram for avian richness: a slow process!</span>
<span class="n">rich.correlog</span> <span class="o">&lt;-</span> <span class="nf">with</span><span class="p">(</span><span class="n">data_sf</span><span class="p">,</span> <span class="nf">correlog</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">avian_richness</span><span class="p">,</span> <span class="n">increment</span><span class="o">=</span><span class="n">cellsize</span><span class="p">,</span> <span class="n">resamp</span><span class="o">=</span><span class="m">0</span><span class="p">))</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">rich.correlog</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_3_64_0.png" src="../_images/practical_3_64_0.png" />
</div>
</div>
<p>To explain that a bit further: we take a focal point and then make pairs of the value of
that point and all other points. These pairs are assigned to bins based on how far apart
the points are: the <code class="docutils literal notranslate"><span class="pre">increment</span></code> is the width of those bins in map units. Once we’ve done
this for all points - yes, that is a lot of pairs! - we calculate the correlations
between the sets of pairs in each bin. Each bin has a mean distance among the points in
that class.</p>
<p>We can get the significance of the correlations at each distance by resampling the data,
but it is a very slow process, which is why the correlograms here have been set not to
do any resampling (<code class="docutils literal notranslate"><span class="pre">resamp=0</span></code>).</p>
<p>We can get more control on that plot by turning the object into a data frame. First, we
can see that the number of pairs in a class drops off dramatically at large distances:
that upswing on the right is based on few pairs, so we can generally ignore it and look
at just shorter distances.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">par</span><span class="p">(</span><span class="n">mfrow</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">))</span>

<span class="c1"># convert three key variables into a data frame</span>
<span class="n">rich.correlog</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">rich.correlog</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">3</span><span class="p">])</span>

<span class="c1"># plot the size of the distance bins</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">n</span> <span class="o">~</span> <span class="n">mean.of.class</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">rich.correlog</span><span class="p">,</span> <span class="n">type</span><span class="o">=</span><span class="s">&#39;o&#39;</span><span class="p">)</span>
<span class="c1"># plot a correlogram for shorter distances</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">correlation</span> <span class="o">~</span> <span class="n">mean.of.class</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">rich.correlog</span><span class="p">,</span> <span class="n">type</span><span class="o">=</span><span class="s">&#39;o&#39;</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="n">mean.of.class</span> <span class="o">&lt;</span> <span class="m">5000</span><span class="p">)</span>
<span class="c1"># add a horizontal  zero correlation line</span>
<span class="nf">abline</span><span class="p">(</span><span class="n">h</span><span class="o">=</span><span class="m">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_3_67_0.png" src="../_images/practical_3_67_0.png" />
</div>
</div>
<p>One key use of correlograms is to assess how well models have controlled for spatial
autocorrelation by looking at the correlation in the residuals. We can compare our two
models like this and see how much better the SAR is at controlling for the
autocorrelation in the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate correlograms for the residuals in the two models</span>
<span class="n">simple.correlog</span> <span class="o">&lt;-</span> <span class="nf">with</span><span class="p">(</span><span class="n">data_sf</span><span class="p">,</span> <span class="nf">correlog</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">simple_resid</span><span class="p">,</span> <span class="n">increment</span><span class="o">=</span><span class="n">cellsize</span><span class="p">,</span> <span class="n">resamp</span><span class="o">=</span><span class="m">0</span><span class="p">))</span>
<span class="n">sar.correlog</span> <span class="o">&lt;-</span> <span class="nf">with</span><span class="p">(</span><span class="n">data_sf</span><span class="p">,</span> <span class="nf">correlog</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sar_resid</span><span class="p">,</span> <span class="n">increment</span><span class="o">=</span><span class="n">cellsize</span><span class="p">,</span> <span class="n">resamp</span><span class="o">=</span><span class="m">0</span><span class="p">))</span>

<span class="c1"># Convert those to make them easier to plot</span>
<span class="n">simple.correlog</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">simple.correlog</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">3</span><span class="p">])</span>
<span class="n">sar.correlog</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">sar.correlog</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">3</span><span class="p">])</span>

<span class="c1"># plot a correlogram for shorter distances</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">correlation</span> <span class="o">~</span> <span class="n">mean.of.class</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">simple.correlog</span><span class="p">,</span> <span class="n">type</span><span class="o">=</span><span class="s">&#39;o&#39;</span><span class="p">,</span> 
     <span class="n">subset</span><span class="o">=</span><span class="n">mean.of.class</span> <span class="o">&lt;</span> <span class="m">5000</span><span class="p">)</span>
<span class="c1"># add the data for the SAR model to compare them</span>
<span class="nf">lines</span><span class="p">(</span><span class="n">correlation</span> <span class="o">~</span> <span class="n">mean.of.class</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">sar.correlog</span><span class="p">,</span> <span class="n">type</span><span class="o">=</span><span class="s">&#39;o&#39;</span><span class="p">,</span> 
      <span class="n">subset</span><span class="o">=</span><span class="n">mean.of.class</span> <span class="o">&lt;</span> <span class="m">5000</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">)</span>

<span class="c1"># add a horizontal  zero correlation line</span>
<span class="nf">abline</span><span class="p">(</span><span class="n">h</span><span class="o">=</span><span class="m">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_3_70_0.png" src="../_images/practical_3_70_0.png" />
</div>
</div>
</div>
</div>
<div class="section" id="generalised-least-squares">
<h2>Generalised least squares<a class="headerlink" href="#generalised-least-squares" title="Permalink to this headline">¶</a></h2>
<p>Generalised least squares (GLS) is an another extension of the linear model framework
that allows us to include the expected correlation between our data points in the model
fitting. The immediate way it differs from spatial autoregressive models is that it does
not use a list of cell neighbourhoods, instead it uses a mathematical function to
describe a model of how correlation changes with distance.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">gls</span></code> function works in the same way as <code class="docutils literal notranslate"><span class="pre">lm</span></code> but permits extra arguments, so we can
fit the simple model:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">gls_simple</span> <span class="o">&lt;-</span> <span class="nf">gls</span><span class="p">(</span><span class="n">avian_richness</span> <span class="o">~</span> <span class="n">mean_aet</span> <span class="o">+</span> <span class="n">mean_temp</span> <span class="o">+</span> <span class="n">elev</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data_sf</span><span class="p">)</span>
<span class="nf">summary</span><span class="p">(</span><span class="n">gls_simple</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Generalized least squares fit by REML
  Model: avian_richness ~ mean_aet + mean_temp + elev 
  Data: data_sf 
       AIC      BIC    logLik
  28858.04 28887.11 -14424.02

Coefficients:
                Value Std.Error  t-value p-value
(Intercept) 198.27669 21.062878  9.41356       0
mean_aet      0.17839  0.004665 38.23824       0
mean_temp    -4.50836  0.713118 -6.32204       0
elev          0.07360  0.005422 13.57341       0

 Correlation: 
          (Intr) mean_t mn_tmp
mean_aet  -0.315              
mean_temp -0.975  0.148       
elev      -0.821  0.184  0.753

Standardized residuals:
       Min         Q1        Med         Q3        Max 
-3.5303243 -0.6523947 -0.0187891  0.6394739  3.9951462 

Residual standard error: 81.24335 
Degrees of freedom: 2479 total; 2475 residual
</pre></div>
</div>
</div>
</div>
<p>That looks very like the normal <code class="docutils literal notranslate"><span class="pre">lm</span></code> output - and indeed the coefficients are identical
to the same model fitted using <code class="docutils literal notranslate"><span class="pre">lm</span></code> above. One difference is <code class="docutils literal notranslate"><span class="pre">gls</span></code> output includes a
matrix showing the correlations between the explanatory variables. If I was being
critical, I would say that elevation and temperature are a rather highly correlated and
that multicollearity might be a problem (see
<a class="reference internal" href="../practical_2/practical_2.html"><span class="doc std std-doc">Practical 2</span></a>).</p>
<p>To add spatial autocorrelation into the model we have to create a spatial correlation
structure. The example below uses the Gaussian model. You can look at <code class="docutils literal notranslate"><span class="pre">?corGaus</span></code> for the
equation but essentially this model describes how the expected correlation decreases
from an initial value with increasing distance until a range threshold is met - after
that the data is expected to be uncorrelated. The constructor needs to know the spatial
coordinates of the data (using <code class="docutils literal notranslate"><span class="pre">form</span></code>) and then the other arguments set the shape of the
curve. You can set <code class="docutils literal notranslate"><span class="pre">fixed=FALSE</span></code> and the model will then try and optimise the range and
nugget parameters, but this can take hours.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define the correlation structure</span>
<span class="n">cor_struct_gauss</span> <span class="o">&lt;-</span> <span class="nf">corGaus</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="n">range</span><span class="o">=</span><span class="m">650</span><span class="p">,</span> <span class="n">nugget</span><span class="o">=</span><span class="m">0.1</span><span class="p">),</span> <span class="n">form</span><span class="o">=~</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span> <span class="n">nugget</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>
<span class="c1"># Add that to the simple model - this might take a few minutes to run!</span>
<span class="n">gls_gauss</span> <span class="o">&lt;-</span> <span class="nf">update</span><span class="p">(</span><span class="n">gls_simple</span><span class="p">,</span>  <span class="n">corr</span><span class="o">=</span><span class="n">cor_struct_gauss</span><span class="p">)</span>
<span class="nf">summary</span><span class="p">(</span><span class="n">gls_gauss</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Generalized least squares fit by REML
  Model: avian_richness ~ mean_aet + mean_temp + elev 
  Data: data_sf 
       AIC      BIC    logLik
  24586.56 24615.63 -12288.28

Correlation Structure: Gaussian spatial correlation
 Formula: ~x + y 
 Parameter estimate(s):
 range nugget 
 650.0    0.1 

Coefficients:
               Value Std.Error   t-value p-value
(Intercept) 357.1643  46.27826  7.717755   0.000
mean_aet      0.0533   0.00851  6.257810   0.000
mean_temp    -7.8843   1.60945 -4.898760   0.000
elev          0.0106   0.00929  1.141019   0.254

 Correlation: 
          (Intr) mean_t mn_tmp
mean_aet  -0.165              
mean_temp -0.926  0.045       
elev      -0.878  0.076  0.935

Standardized residuals:
       Min         Q1        Med         Q3        Max 
-2.0344981 -0.0253260  0.6173762  1.1890697  4.3973486 

Residual standard error: 96.62373 
Degrees of freedom: 2479 total; 2475 residual
</pre></div>
</div>
</div>
</div>
<p>That output looks very similar but now includes a description of the correlation
structure. Note that all of the <strong>model coefficients have changed</strong> and the
<strong>significance of the variables</strong> has changed. Elevation is no longer significant when
we account for autocorrelation.</p>
<p>We can map the two model predictions</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">data_sf</span><span class="o">$</span><span class="n">gls_simple_pred</span> <span class="o">&lt;-</span> <span class="nf">predict</span><span class="p">(</span><span class="n">gls_simple</span><span class="p">)</span>
<span class="n">data_sf</span><span class="o">$</span><span class="n">gls_gauss_pred</span> <span class="o">&lt;-</span> <span class="nf">predict</span><span class="p">(</span><span class="n">gls_gauss</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">data_sf</span><span class="p">[</span><span class="nf">c</span><span class="p">(</span><span class="s">&#39;gls_simple_pred&#39;</span><span class="p">,</span><span class="s">&#39;gls_gauss_pred&#39;</span><span class="p">)],</span> <span class="n">key.pos</span><span class="o">=</span><span class="m">4</span><span class="p">,</span> <span class="n">cex</span><span class="o">=</span><span class="m">0.6</span><span class="p">,</span> <span class="n">pch</span><span class="o">=</span><span class="m">20</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_3_77_0.png" src="../_images/practical_3_77_0.png" />
</div>
</div>
<div class="admonition-compare-the-residual-autocorrelation admonition">
<p class="admonition-title">Compare the residual autocorrelation</p>
<p>Using the example at the end of the section on <a class="reference external" href="#autoregressive-models">autoregressive
models</a>, create this plot comparing the autocorrelation in the
residuals from the two GLS models.</p>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1">#Extract the residuals</span>
<span class="n">data_sf</span><span class="o">$</span><span class="n">gls_simple_resid</span> <span class="o">&lt;-</span> <span class="nf">resid</span><span class="p">(</span><span class="n">gls_simple</span><span class="p">)</span>
<span class="n">data_sf</span><span class="o">$</span><span class="n">gls_gauss_resid</span> <span class="o">&lt;-</span> <span class="nf">resid</span><span class="p">(</span><span class="n">gls_gauss</span><span class="p">)</span>

<span class="c1"># Calculate correlograms for the residuals in the two models</span>
<span class="n">simple.correlog</span> <span class="o">&lt;-</span> <span class="nf">with</span><span class="p">(</span><span class="n">data_sf</span><span class="p">,</span> 
                        <span class="nf">correlog</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">gls_simple_resid</span><span class="p">,</span> 
                                 <span class="n">increment</span><span class="o">=</span><span class="n">cellsize</span><span class="p">,</span> <span class="n">resamp</span><span class="o">=</span><span class="m">0</span><span class="p">))</span>
<span class="n">gauss.correlog</span> <span class="o">&lt;-</span> <span class="nf">with</span><span class="p">(</span><span class="n">data_sf</span><span class="p">,</span> 
                       <span class="nf">correlog</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">gls_gauss_resid</span><span class="p">,</span> 
                                <span class="n">increment</span><span class="o">=</span><span class="n">cellsize</span><span class="p">,</span> <span class="n">resamp</span><span class="o">=</span><span class="m">0</span><span class="p">))</span>

<span class="c1"># Convert those to make them easier to plot</span>
<span class="n">simple.correlog</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">simple.correlog</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">3</span><span class="p">])</span>
<span class="n">gauss.correlog</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">gauss.correlog</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">3</span><span class="p">])</span>

<span class="c1"># plot a correlogram for shorter distances</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">correlation</span> <span class="o">~</span> <span class="n">mean.of.class</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">simple.correlog</span><span class="p">,</span> <span class="n">type</span><span class="o">=</span><span class="s">&#39;o&#39;</span><span class="p">,</span> 
     <span class="n">subset</span><span class="o">=</span><span class="n">mean.of.class</span> <span class="o">&lt;</span> <span class="m">5000</span><span class="p">)</span>
<span class="c1"># add the data for the SAR model to compare them</span>
<span class="nf">lines</span><span class="p">(</span><span class="n">correlation</span> <span class="o">~</span> <span class="n">mean.of.class</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">gauss.correlog</span><span class="p">,</span> <span class="n">type</span><span class="o">=</span><span class="s">&#39;o&#39;</span><span class="p">,</span>
      <span class="n">subset</span><span class="o">=</span><span class="n">mean.of.class</span> <span class="o">&lt;</span> <span class="m">5000</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">)</span>

<span class="c1"># add a horizontal  zero correlation line</span>
<span class="nf">abline</span><span class="p">(</span><span class="n">h</span><span class="o">=</span><span class="m">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_3_80_0.png" src="../_images/practical_3_80_0.png" />
</div>
</div>
<p>Oh dear - that is <strong>not the improvement we were looking for</strong>. We can also look at the
relationship between observed and predicted richness. It is clear that - although it may
be dealing with spatial autocorrelation - this spatial GLS is not a good description of
the data! Do not forget that <strong>all models require careful model criticism</strong>!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">par</span><span class="p">(</span><span class="n">mfrow</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">),</span> <span class="n">mar</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">3</span><span class="p">,</span><span class="m">3</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">),</span> <span class="n">mgp</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">0</span><span class="p">))</span>
<span class="c1"># set the plot limits to show the scaling clearly</span>
<span class="n">lims</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="nf">max</span><span class="p">(</span><span class="n">data_sf</span><span class="o">$</span><span class="n">avian_richness</span><span class="p">))</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">avian_richness</span> <span class="o">~</span> <span class="n">gls_simple_pred</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data_sf</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="n">lims</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="n">lims</span><span class="p">)</span>
<span class="nf">abline</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="m">0</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="m">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">,</span> <span class="n">lwd</span><span class="o">=</span><span class="m">2</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">avian_richness</span> <span class="o">~</span> <span class="n">gls_gauss_pred</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data_sf</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="n">lims</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="n">lims</span><span class="p">)</span>
<span class="nf">abline</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="m">0</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="m">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">,</span> <span class="n">lwd</span><span class="o">=</span><span class="m">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_3_83_0.png" src="../_images/practical_3_83_0.png" />
</div>
</div>
</div>
<div class="section" id="eigenvector-filtering">
<h2>Eigenvector filtering<a class="headerlink" href="#eigenvector-filtering" title="Permalink to this headline">¶</a></h2>
<p>This is yet another approach to incorporating spatial structure. In the example below,
we take a set of neighbourhood weights and convert them into eigenvector filters using
the <code class="docutils literal notranslate"><span class="pre">meigen</span></code> function from <code class="docutils literal notranslate"><span class="pre">spmoran</span></code>. Again, the package vignette is a great place for
further data (although the vignette name is a bit unhelpfully generic!)</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">vignette</span><span class="p">(</span><span class="s">&#39;vignettes&#39;</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="s">&#39;spmoran&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">packageVersion</span><span class="p">(</span><span class="s">&#39;spmoran&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1] ‘0.2.2.6’
</pre></div>
</div>
</div>
</div>
<div class="admonition-sidebar-about-package-quality admonition">
<p class="admonition-title">Sidebar about package quality</p>
<p>If you look at the package version of <code class="docutils literal notranslate"><span class="pre">spmoran</span></code> above, you will see that it
is less than version 1.0.0.</p>
<p>A version number less than 1.0.0 usually means that the package is in
development. It is often a good idea to be wary of in development and
infrequently used packages: packages on CRAN have to be formatted correctly so
that they build and install cleanly but there is no systematic check that the
code they contain works correctly.</p>
<p>In this case, Daisuke Murakami is a co-author of many papers with Daniel
Griffith on eigenvector filtering and the quality and detail in the vignette is
an <em>excellent</em> indication of the care and attention put into the package.</p>
<blockquote>
<div><p>Murakami, D. and Griffith, D.A. (2015) Random effects specifications in
eigenvector spatial filtering: a simulation study. Journal of Geographical
Systems, 17 (4), 311-331.</p>
</div></blockquote>
</div>
<p>In order to use this, we first need to extract the eigenvectors from our neighbourhood
list. We need a different format, so we need to recreate the initial neighbours and then
convert those to a weights <em>matrix</em> rather than sets of neighbour weights.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get the neighbours</span>
<span class="n">queen</span> <span class="o">&lt;-</span> <span class="nf">dnearneigh</span><span class="p">(</span><span class="n">data_sf</span><span class="p">,</span> <span class="n">d1</span><span class="o">=</span><span class="m">0</span><span class="p">,</span> <span class="n">d2</span><span class="o">=</span><span class="nf">sqrt</span><span class="p">(</span><span class="m">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">cellsize</span> <span class="o">+</span> <span class="m">1</span><span class="p">)</span>
<span class="c1"># Convert to eigenvector filters - this is a bit slow</span>
<span class="n">queen_eigen</span> <span class="o">&lt;-</span> <span class="nf">meigen</span><span class="p">(</span><span class="n">cmat</span> <span class="o">=</span> <span class="nf">nb2mat</span><span class="p">(</span><span class="n">queen</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s">&#39;W&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> Note: cmat is symmetrized by ( cmat + t( cmat ) ) / 2
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 836/2479 eigen-pairs are extracted
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">queen_eigen</span></code> object contains a matrix <code class="docutils literal notranslate"><span class="pre">sf</span></code> of spatial filters (not the same as the
<code class="docutils literal notranslate"><span class="pre">sf</span></code> data frame class!) and a vector <code class="docutils literal notranslate"><span class="pre">ev</span></code> of eigenvalues. Each column in
<code class="docutils literal notranslate"><span class="pre">queen_eigen$sf</span></code> shows a different pattern in the spatial structure and has a value for
each data point; the corresponding eigenvalue is a measure of the strength of that
pattern.</p>
<p>We’ll look at some examples:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Convert the `sf` matrix of eigenvectors into a data frame</span>
<span class="n">queen_eigen_filters</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">queen_eigen</span><span class="o">$</span><span class="n">sf</span><span class="p">)</span>
<span class="nf">names</span><span class="p">(</span><span class="n">queen_eigen_filters</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">paste0</span><span class="p">(</span><span class="s">&#39;ev_&#39;</span><span class="p">,</span> <span class="m">1</span><span class="o">:</span><span class="nf">ncol</span><span class="p">(</span><span class="n">queen_eigen_filters</span><span class="p">))</span>

<span class="c1"># Combine this with the model data frame - note this approach</span>
<span class="c1"># for combining an sf dataframe and another dataframe by rows</span>
<span class="n">data_sf</span> <span class="o">&lt;-</span> <span class="nf">st_sf</span><span class="p">(</span><span class="nf">data.frame</span><span class="p">(</span><span class="n">data_sf</span><span class="p">,</span> <span class="n">queen_eigen_filters</span><span class="p">))</span>

<span class="c1"># Visualise 9 of the strongest filters and 1 weaker one for comparison</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">data_sf</span><span class="p">[</span><span class="nf">c</span><span class="p">(</span><span class="s">&#39;ev_1&#39;</span><span class="p">,</span> <span class="s">&#39;ev_2&#39;</span><span class="p">,</span> <span class="s">&#39;ev_3&#39;</span><span class="p">,</span> <span class="s">&#39;ev_4&#39;</span><span class="p">,</span> <span class="s">&#39;ev_5&#39;</span><span class="p">,</span> <span class="s">&#39;ev_6&#39;</span><span class="p">,</span> 
               <span class="s">&#39;ev_7&#39;</span><span class="p">,</span> <span class="s">&#39;ev_8&#39;</span><span class="p">,</span> <span class="s">&#39;ev_9&#39;</span><span class="p">,</span> <span class="s">&#39;ev_800&#39;</span><span class="p">)],</span>
     <span class="n">pal</span><span class="o">=</span><span class="n">hcl.colors</span><span class="p">,</span> <span class="n">max.plot</span><span class="o">=</span><span class="m">10</span><span class="p">,</span> <span class="n">cex</span><span class="o">=</span><span class="m">0.2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_3_90_0.png" src="../_images/practical_3_90_0.png" />
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">spmoran</span></code> package provides a set of more sophisticated (and time-consuming)
approaches but here we are simply going to add some eigenvector filters to a standard
linear model. We will use the first 9 eigenvectors.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">eigen_mod</span> <span class="o">&lt;-</span> <span class="nf">lm</span><span class="p">(</span><span class="n">avian_richness</span> <span class="o">~</span> <span class="n">mean_aet</span> <span class="o">+</span> <span class="n">elev</span> <span class="o">+</span> <span class="n">mean_temp</span> <span class="o">+</span> <span class="n">ev_1</span> <span class="o">+</span> <span class="n">ev_2</span> <span class="o">+</span>
                <span class="n">ev_3</span> <span class="o">+</span> <span class="n">ev_4</span> <span class="o">+</span> <span class="n">ev_5</span> <span class="o">+</span> <span class="n">ev_6</span> <span class="o">+</span> <span class="n">ev_7</span> <span class="o">+</span> <span class="n">ev_8</span> <span class="o">+</span> <span class="n">ev_9</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data_sf</span><span class="p">)</span>
<span class="nf">summary</span><span class="p">(</span><span class="n">eigen_mod</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Call:
lm(formula = avian_richness ~ mean_aet + elev + mean_temp + ev_1 + 
    ev_2 + ev_3 + ev_4 + ev_5 + ev_6 + ev_7 + ev_8 + ev_9, data = data_sf)

Residuals:
     Min       1Q   Median       3Q      Max 
-186.443  -49.031    0.535   48.127  315.401 

Coefficients:
              Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  2.506e+02  3.536e+01   7.086 1.79e-12 ***
mean_aet     1.443e-01  5.567e-03  25.917  &lt; 2e-16 ***
elev         5.575e-02  6.288e-03   8.867  &lt; 2e-16 ***
mean_temp   -5.142e+00  1.227e+00  -4.190 2.89e-05 ***
ev_1         3.781e+02  7.007e+01   5.396 7.48e-08 ***
ev_2         1.560e+03  7.314e+01  21.333  &lt; 2e-16 ***
ev_3        -1.056e+03  7.256e+01 -14.558  &lt; 2e-16 ***
ev_4        -1.997e+02  1.182e+02  -1.690   0.0912 .  
ev_5         1.557e+02  1.032e+02   1.509   0.1315    
ev_6         1.916e+02  9.099e+01   2.106   0.0353 *  
ev_7         1.508e+02  7.029e+01   2.146   0.0320 *  
ev_8         1.166e+03  7.479e+01  15.585  &lt; 2e-16 ***
ev_9        -3.158e+02  6.994e+01  -4.515 6.62e-06 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 68.23 on 2466 degrees of freedom
Multiple R-squared:  0.6251,	Adjusted R-squared:  0.6232 
F-statistic: 342.6 on 12 and 2466 DF,  p-value: &lt; 2.2e-16
</pre></div>
</div>
</div>
</div>
<p>In that output, we do not really care about the coefficients for each filter: those
elements are just in the model to control for spatial autocorrelation. We might want to
remove filters that are not significant.</p>
<p>Using the tools above, we can look at the residual spatial autocorrelation and
predictions from this model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">data_sf</span><span class="o">$</span><span class="n">eigen_fit</span> <span class="o">&lt;-</span> <span class="nf">predict</span><span class="p">(</span><span class="n">eigen_mod</span><span class="p">)</span>
<span class="n">data_sf</span><span class="o">$</span><span class="n">eigen_resid</span> <span class="o">&lt;-</span> <span class="nf">resid</span><span class="p">(</span><span class="n">eigen_mod</span><span class="p">)</span>

<span class="n">eigen.correlog</span> <span class="o">&lt;-</span> <span class="nf">with</span><span class="p">(</span><span class="n">data_sf</span><span class="p">,</span> <span class="nf">correlog</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">eigen_resid</span><span class="p">,</span> <span class="n">increment</span><span class="o">=</span><span class="n">cellsize</span><span class="p">,</span> <span class="n">resamp</span><span class="o">=</span><span class="m">0</span><span class="p">))</span>
<span class="n">eigen.correlog</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">eigen.correlog</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">3</span><span class="p">])</span>

<span class="nf">par</span><span class="p">(</span><span class="n">mfrow</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">))</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">data_sf</span><span class="p">[</span><span class="s">&#39;eigen_fit&#39;</span><span class="p">],</span> <span class="n">pch</span><span class="o">=</span><span class="m">20</span><span class="p">,</span> <span class="n">cex</span><span class="o">=</span><span class="m">0.7</span><span class="p">,</span>  <span class="n">key.pos</span><span class="o">=</span><span class="kc">NULL</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span>
<span class="c1"># plot a correlogram for shorter distances</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">correlation</span> <span class="o">~</span> <span class="n">mean.of.class</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">simple.correlog</span><span class="p">,</span> <span class="n">type</span><span class="o">=</span><span class="s">&#39;o&#39;</span><span class="p">,</span> 
     <span class="n">subset</span><span class="o">=</span><span class="n">mean.of.class</span> <span class="o">&lt;</span> <span class="m">5000</span><span class="p">)</span>
<span class="c1"># add the data for the SAR model to compare them</span>
<span class="nf">lines</span><span class="p">(</span><span class="n">correlation</span> <span class="o">~</span> <span class="n">mean.of.class</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">eigen.correlog</span><span class="p">,</span> <span class="n">type</span><span class="o">=</span><span class="s">&#39;o&#39;</span><span class="p">,</span> 
      <span class="n">subset</span><span class="o">=</span><span class="n">mean.of.class</span> <span class="o">&lt;</span> <span class="m">5000</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/practical_3_94_0.png" src="../_images/practical_3_94_0.png" />
</div>
</div>
<p>That is not much of an improvement either. To be fair to the <code class="docutils literal notranslate"><span class="pre">spmoran</span></code> package, the
approach is intended to consider a much larger set of filters and go through a selection
process. The modelling functions in <code class="docutils literal notranslate"><span class="pre">spmoran</span></code> do not use the formula interface - which
is a bit hardcore - but the code would be as follows. I <strong>do not recommend running</strong>
this now - I have no idea of how long it would take to finish but it is at least quarter
of an hour and might be days.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get a dataframe of the explanatory variables</span>
<span class="n">expl</span> <span class="o">&lt;-</span> <span class="n">data_sf</span><span class="p">[,</span><span class="nf">c</span><span class="p">(</span><span class="s">&#39;elev&#39;</span><span class="p">,</span><span class="s">&#39;mean_temp&#39;</span><span class="p">,</span><span class="s">&#39;mean_aet&#39;</span><span class="p">)]</span>
<span class="c1"># This retains the geometry, so we need to convert back to a simple dataframe</span>
<span class="nf">st_geometry</span><span class="p">(</span><span class="n">expl</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="kc">NULL</span>
<span class="c1"># Fit the model, optimising the AIC</span>
<span class="n">eigen_spmoran</span> <span class="o">&lt;-</span> <span class="nf">esf</span><span class="p">(</span><span class="n">data_sf</span><span class="o">$</span><span class="n">avian_richness</span><span class="p">,</span> <span class="n">expl</span><span class="p">,</span> <span class="n">meig</span><span class="o">=</span><span class="n">queen_eigen</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="s">&#39;aic&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "ir420"
        },
        kernelOptions: {
            kernelName: "ir420",
            path: "./practical_3"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'ir420'</script>

              </div>
              
        
            



<div class='prev-next-bottom'>
    
    <div id="prev">
        <a class="left-prev" href="../practical_2/practical_2.html" title="previous page">
            <i class="prevnext-label fas fa-angle-left"></i>
            <div class="prevnext-info">
                <p class="prevnext-label">previous</p>
                <p class="prevnext-title">Practical Two: Species Distribution Modelling</p>
            </div>
        </a>
    </div>
     <div id="next">
        <a class="right-next" href="../practical_4/LEC_week.html" title="next page">
            <div class="prevnext-info">
                <p class="prevnext-label">next</p>
                <p class="prevnext-title">Landscape Ecology and Conservation</p>
            </div>
            <i class="prevnext-label fas fa-angle-right"></i>
        </a>
     </div>

</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By David Orme<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>